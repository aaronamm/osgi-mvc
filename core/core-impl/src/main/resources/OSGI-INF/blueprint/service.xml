<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:ext="http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.0.0"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd">

    <!-- Template repository manager, used to resolve a URL based on a template name -->
    <bean id="templateRepositoryManager" class="com.funnic.mvc.core.impl.repository.TemplateRepositoryManagerImpl" />

    <!-- Listen for Template Repositories registered in the OSGi container -->
    <reference-list interface="com.funnic.mvc.core.api.repository.TemplateRepository" availability="optional">
        <reference-listener ref="templateRepositoryManager" bind-method="addTemplateRepository"
                            unbind-method="removeTemplateRepository"/>
    </reference-list>

    <!-- Template manager used to get a single-point entry method for processing template files -->
    <bean id="templateEngineManager" class="com.funnic.mvc.core.impl.templating.TemplateEngineManagerImpl" />

    <!-- Listen for Template Engines registered in the OSGi container -->
    <reference-list interface="com.funnic.mvc.core.api.templating.TemplateEngine" availability="optional">
        <reference-listener ref="templateEngineManager" bind-method="addTemplateEngine"
                            unbind-method="removeTemplateEngine"/>
    </reference-list>

    <bean id="controllerInfoFactory" class="com.funnic.mvc.core.impl.controllers.ControllerInfoFactoryImpl" />

    <bean id="controllerRepository" class="com.funnic.mvc.core.impl.controllers.ControllerRepositoryImpl">
        <argument ref="controllerInfoFactory"/>
    </bean>

    <reference-list interface="com.funnic.mvc.core.api.Controller" availability="optional">
        <reference-listener ref="controllerRepository" bind-method="addController" unbind-method="removeController"/>
    </reference-list>

    <cm:property-placeholder persistent-id="com.funnic.mvc.core" update-strategy="reload">
        <cm:default-properties>
            <cm:property name="contextPath" value="/demo"/>
        </cm:default-properties>
    </cm:property-placeholder>

    <bean id="stringConverter" class="com.funnic.mvc.core.impl.converters.StringConverter" />
    <bean id="bigDecimalConverter" class="com.funnic.mvc.core.impl.converters.BigDecimalConverter" />

    <bean id="controllerRenderer" class="com.funnic.mvc.core.impl.controllers.ControllerRendererImpl">
        <argument ref="controllerRepository" />
        <argument ref="templateEngineManager" />
        <argument>
            <list value-type="com.funnic.mvc.core.api.ParameterConverter">
                <ref component-id="stringConverter"/>
                <ref component-id="bigDecimalConverter"/>
            </list>
        </argument>
    </bean>

    <reference-list interface="com.funnic.mvc.core.api.ParameterConverter" availability="optional">
        <reference-listener ref="controllerRenderer" bind-method="addConverter" unbind-method="removeConverter"/>
    </reference-list>

    <bean id="mvcServlet" class="com.funnic.mvc.core.impl.servlet.MvcServlet">
        <argument value="${contextPath}"/>
        <argument ref="controllerRenderer"/>
    </bean>

    <!-- Expose the web servlet -->
    <service ref="mvcServlet" interface="javax.servlet.http.HttpServlet">
        <service-properties>
            <entry key="alias" value="${contextPath}"/>
        </service-properties>
    </service>

    <service ref="controllerRenderer" interface="com.funnic.mvc.core.api.renderer.ControllerRenderer" />
    <service ref="templateEngineManager" interface="com.funnic.mvc.core.api.templating.TemplateEngineManager" />

</blueprint>